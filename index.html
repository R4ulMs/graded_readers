<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Reader</title>
    <style>
        :root {
            --topbar-h: 28px;
            --footer-h: 25px;
        }

        body {
            background-color: #1c1c1c;
            font-family: "Open Sans", sans-serif;
            font-weight: 400;
            font-size: 24px;
            line-height: 1.583;
            letter-spacing: 0.32px;
            text-align: justify;
            display: flex;
            justify-content: center;
        }

        .reader {
            max-width: 994px;
            min-width: 994px;
            padding: 40px;
            color: #cfcfcf;
            background-color: #000;
            padding-left: 125px;
            padding-right: 125px;
            box-sizing: border-box;
            height: calc(100vh - var(--topbar-h) - var(--footer-h));
            margin-top: var(--topbar-h);
            margin-bottom: var(--footer-h);
            overflow: hidden;
        }

        .reader .phrase:hover {
            background: #2a2a2a;
            color: #fff;
            cursor: pointer;
        }

        .topbar {
            position: fixed;
            inset: 0 0 auto 0;
            height: 35px;
            background: #000;
            display: grid;
            place-items: center;
            border-bottom: 1px solid #1f1f1f;
            z-index: 10;
        }

        .topbar.title {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: space-around;
            color: #ccc;
            font-size: 16px;
            border-top: 1px solid #333;
            z-index: 10;
        }

        .footer .progress {
            font-size: 14px;
        }

        .footer .nav-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 26px;
            cursor: pointer;
            padding: 8px;
        }

        .footer .nav-btn:hover {
            color: #fff;
        }

        #measurer {
            position: absolute;
            visibility: hidden;
            left: -9999px;
            top: -9999px;
            width: 994px;
            padding: 40px 125px;
            box-sizing: border-box;
            font-size: 24px;
            line-height: 1.583;
            letter-spacing: 0.32px;
            text-align: justify;
            white-space: normal;
        }

        /* Tooltip flutuante simples */
        .tooltip-float {
            position: fixed;
            display: none;
            z-index: 1000;
            background: #181818;
            color: #e6e6e6;
            border: 1px solid #333;
            border-radius: 3px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .5);
            min-width: 220px;
            max-width: 360px;
            padding: 10px 12px;
            font-size: 18px;
            line-height: 1.35;
        }

        .tooltip-float.show {
            display: block;
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="topbar title">A Sea of Darkness</div>
    </header>

    <div class="reader"></div>

    <div class="footer">
        <button class="nav-btn">❮</button>
        <span class="progress">0%</span>
        <button class="nav-btn">❯</button>
    </div>

    <!-- medidor invisível -->
    <div id="measurer" aria-hidden="true"></div>

    <!-- tooltip flutuante -->
    <div id="tooltip" class="tooltip-float" role="tooltip"></div>

    <script>
        // ===== 1) SEU CONTEÚDO AGORA EM JSON (frases + tooltip) =====
        const story = {
            "page1": [
                { "phrase": "Maria acordou cedo", "tooltip": "Início do dia" },
                { "phrase": "O sol já brilhava na janela", "tooltip": "Manhã ensolarada" },
                { "phrase": "Ela se espreguiçou devagar", "tooltip": "Acordando o corpo" },
                { "phrase": "Foi até a cozinha", "tooltip": "Primeiro destino" },
                { "phrase": "Preparou um copo de água", "tooltip": "Hábito saudável" },
                { "phrase": "Olhou o relógio", "tooltip": "Verificar horário" },
                { "phrase": "Percebeu que estava com fome", "tooltip": "Sensação matinal" },
                { "phrase": "Decidiu ir à padaria", "tooltip": "Tomada de decisão" },
                { "phrase": "Colocou um casaco leve", "tooltip": "Preparando-se para sair" },
                { "phrase": "Saiu de casa", "tooltip": "Início do trajeto" },
                { "phrase": "As ruas estavam tranquilas", "tooltip": "Ambiente calmo" },
                { "phrase": "Cumprimentou a vizinha", "tooltip": "Interação rápida" },
                { "phrase": "Chegando à padaria", "tooltip": "No local" },
                { "phrase": "Viu uma pequena fila", "tooltip": "Movimento do lugar" },
                { "phrase": "Queria comprar pão", "tooltip": "Objetivo principal" },
                { "phrase": "Notou que os pães haviam acabado", "tooltip": "Decepção" },
                { "phrase": "Maria suspirou fundo", "tooltip": "Reação emocional" },
                { "phrase": "Pensou em outras opções", "tooltip": "Reflexão rápida" },
                { "phrase": "Decidiu comprar café", "tooltip": "Nova escolha" },
                { "phrase": "Pegou também um pedaço de bolo", "tooltip": "Pequena indulgência" },
                { "phrase": "Pagou no caixa", "tooltip": "Finalizando a compra" },
                { "phrase": "Agradeceu ao atendente", "tooltip": "Gentileza" },
                { "phrase": "Saiu da padaria", "tooltip": "Fim da compra" },
                { "phrase": "Sentiu o cheiro do café fresco", "tooltip": "Sensação agradável" },
                { "phrase": "Começou a voltar pra casa", "tooltip": "Retorno" },
                { "phrase": "Reparou nas flores da calçada", "tooltip": "Detalhes do caminho" },
                { "phrase": "Ouviu pássaros cantando", "tooltip": "Som ambiente" },
                { "phrase": "Entrou em casa novamente", "tooltip": "Chegada" },
                { "phrase": "Preparou a mesa para o café da manhã", "tooltip": "Organização" },
                { "phrase": "Ficou contente com o início do dia", "tooltip": "Fim feliz" },
                { "phrase": "Pegou uma xícara bonita do armário", "tooltip": "Escolha cuidadosa" },
                { "phrase": "Serviu o café fumegante", "tooltip": "Primeiro gole chegando" },
                { "phrase": "O aroma se espalhou pela cozinha", "tooltip": "Atmosfera aconchegante" },
                { "phrase": "Cortou um pedaço do bolo", "tooltip": "Preparando o prato" },
                { "phrase": "Deu a primeira mordida", "tooltip": "Início do café da manhã" },
                { "phrase": "Sorriu ao sentir o sabor doce", "tooltip": "Pequena felicidade" },
                { "phrase": "Olhou pela janela", "tooltip": "Momento de contemplação" },
                { "phrase": "Viu crianças brincando na rua", "tooltip": "Cena cotidiana" },
                { "phrase": "Lembrou da sua infância", "tooltip": "Recordação" },
                { "phrase": "Sentiu uma onda de nostalgia", "tooltip": "Emoção suave" },
                { "phrase": "Terminou seu café lentamente", "tooltip": "Aproveitando o momento" },
                { "phrase": "Decidiu anotar suas tarefas do dia", "tooltip": "Organização pessoal" },
                { "phrase": "Pegou papel e caneta", "tooltip": "Preparando-se" },
                { "phrase": "Escreveu uma pequena lista", "tooltip": "Planejamento" },
                { "phrase": "Percebeu que o dia seria produtivo", "tooltip": "Perspectiva positiva" }
            ]
        };

        const escapeHtml = (s) => s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const strip = (html) => {
            const d = document.createElement('div');
            d.innerHTML = html;
            return (d.textContent || d.innerText || '').replace(/\s+/g, ' ').trim();
        };

        const syncMeasurerStyle = (readerEl, measurerEl) => {
            const cs = getComputedStyle(readerEl);
            measurerEl.style.width = cs.width;
            measurerEl.style.paddingTop = cs.paddingTop;
            measurerEl.style.paddingRight = cs.paddingRight;
            measurerEl.style.paddingBottom = cs.paddingBottom;
            measurerEl.style.paddingLeft = cs.paddingLeft;
            measurerEl.style.boxSizing = cs.boxSizing;
            measurerEl.style.fontFamily = cs.fontFamily;
            measurerEl.style.fontSize = cs.fontSize;
            measurerEl.style.lineHeight = cs.lineHeight;
            measurerEl.style.letterSpacing = cs.letterSpacing;
            measurerEl.style.textAlign = cs.textAlign;
            measurerEl.style.whiteSpace = "normal";
        }

        const isFitPage = (text, readerEl, measurerEl) => {
            measurerEl.innerHTML = "<p>" + escapeHtml(text) + "</p>";
            const hM = measurerEl.getBoundingClientRect().height;
            const hR = readerEl.getBoundingClientRect().height;
            return hM <= hR + 0.5;
        }

        const fitPage = (paragraph) => {
            const readerEl = document.querySelector(".reader");
            const measurerEl = document.getElementById("measurer");
            syncMeasurerStyle(readerEl, measurerEl);

            let low = 0;
            let high = paragraph.length;
            let best = 0;

            if (isFitPage(paragraph, readerEl, measurerEl)) return paragraph.length;

            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                const candidate = paragraph.slice(0, mid) + "…";
                if (isFitPage(candidate, readerEl, measurerEl)) {
                    best = mid;
                    low = mid + 1;
                } else {
                    high = mid - 1;
                }
            }
            return best;
        }

        function buildFullTextWithIndex(items) {
            let fullText = "";
            const index = []
            let pos = 0;

            items.forEach((it, i) => {
                if (i > 0) {
                    fullText += " "; pos += 1;
                }

                const start = pos;
                fullText += it.phrase;
                const end = pos + it.phrase.length;
                index.push({ start, end, tooltip: it.tooltip });
                pos = end;
            });

            return { fullText, index };
        }

        function paginateRanges(fullText) {
            const pages = [];
            let rest = fullText;
            let offset = 0;

            while (rest.length > 0) {
                const take = fitPage(rest);
                const len = take > 0 ? take : Math.min(100, rest.length); // fallback
                pages.push({ start: offset, end: offset + len });
                rest = rest.slice(len);
                offset += len;
            }

            return pages;
        }

        // ===== 4) Constrói HTML de uma página, marcando frases que cruzam o range =====
        function buildPageHtml(fullText, phraseIndex, range) {
            // pegue todas as frases que intersectam [range.start, range.end)
            const overlaps = phraseIndex
                .filter(({ start, end }) => end > range.start && start < range.end)
                .sort((a, b) => a.start - b.start);

            let html = "";
            let cursor = range.start;

            const pushRaw = (from, to) => {
                if (to > from) html += escapeHtml(fullText.slice(from, to));
            };

            overlaps.forEach(({ start, end, tooltip }) => {
                const s = Math.max(start, range.start);
                const e = Math.min(end, range.end);

                // 1) texto cru antes da frase
                pushRaw(cursor, s);

                // 2) trecho da frase (pode ser parcial se cortada na página)
                const frag = fullText.slice(s, e);
                html += `<span class="phrase" data-tip="${escapeHtml(tooltip)}">${escapeHtml(frag)}</span>`;
                cursor = e;
            });

            // 3) cauda depois da última frase
            pushRaw(cursor, range.end);

            return html;
        }

        const tipEl = document.getElementById('tooltip');
        function showTooltip(target, text) {
            tipEl.textContent = text;
            const r = target.getBoundingClientRect();
            const pad = 6;
            const top = r.bottom + window.scrollY + pad;
            let left = r.left + window.scrollX;

            tipEl.style.display = 'block'; 
            const maxLeft = window.scrollX + document.documentElement.clientWidth - tipEl.offsetWidth - 8;
            if (left > maxLeft) left = maxLeft;

            tipEl.style.top = `${top}px`;
            tipEl.style.left = `${left}px`;
            tipEl.classList.add('show');
        }
        
        function hideTooltip() { tipEl.classList.remove('show'); tipEl.style.display = 'none'; }

        window.addEventListener("DOMContentLoaded", () => {
            const items = story.page1;                          // <- usa o JSON
            const { fullText, index: phraseIndex } = buildFullTextWithIndex(items);
            const pages = paginateRanges(fullText);

            let page = 0;
            const reader = document.querySelector(".reader");
            const progress = document.querySelector(".progress");
            const [prevBtn, nextBtn] = document.querySelectorAll(".nav-btn");

            function render() {
                const range = pages[page];
                reader.innerHTML = buildPageHtml(fullText, phraseIndex, range);

                progress.textContent = `${Math.round(((page + 1) / pages.length) * 100)}%`;
                prevBtn.disabled = page === 0;
                nextBtn.disabled = page === pages.length - 1;

                reader.querySelectorAll('.phrase').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tip = el.getAttribute('data-tip');
                        showTooltip(el, tip || "");
                    });
                });
            }


            prevBtn.addEventListener("click", () => { if (page > 0) { page--; hideTooltip(); render(); } });
            nextBtn.addEventListener("click", () => { if (page < pages.length - 1) { page++; hideTooltip(); render(); } });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.phrase')) hideTooltip();
            });

            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideTooltip(); });

            render();
        });
    </script>
</body>

</html>
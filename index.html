<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <title>Reader</title>
    <style>
        body {
            background-color: #1c1c1c;
            font-family: "Open Sans", sans-serif;
            font-weight: 400;
            font-size: 24px;
            line-height: 1.583;
            letter-spacing: 0.32px;
            text-align: justify;
            display: flex;
            justify-content: center;
        }

        .reader {
            max-width: 994px;
            min-width: 994px;
            padding: 40px;
            color: #cfcfcf;
            background-color: #000;
            padding-left: 125px;
            padding-right: 125px;
        
            box-sizing: border-box; 
            height: 640px; 
            overflow: hidden;
        }

        .reader span:hover {
            color: #000;
            background-color: #cecece;
            cursor: pointer;
        }

        .topbar {
            position: fixed;
            inset: 0 0 auto 0;
            height: 35px;
            background: #000;
            display: grid;
            place-items: center;
            border-bottom: 1px solid #1f1f1f;
            z-index: 10;
        }

        .topbar.title {
            font-family: "Open Sans", sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: space-around;
            color: #ccc;
            font-size: 16px;
            border-top: 1px solid #333;
            z-index: 10;
        }

        .footer .progress {
            font-size: 14px;
        }

        .footer .nav-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 26px;
            cursor: pointer;
            padding: 8px;
        }

        .footer .nav-btn:hover {
            color: #fff;
        }

        /* medidor invisível: terá o mesmo estilo que .reader */
        #measurer {
            position: absolute;
            visibility: hidden;
            left: -9999px;
            top: -9999px;
            width: 994px;
            /* will update dynamically to match reader's content width */
            padding: 40px 125px;
            box-sizing: border-box;
            font-size: 24px;
            line-height: 1.583;
            letter-spacing: 0.32px;
            text-align: justify;
            white-space: normal;
        }
    </style>
    <script>
        const strip = (html) => {
            let tmp = document.createElement("div");
            tmp.innerHTML = html;
            const text = tmp.textContent || tmp.innerText || "";

            return text.replace(/\s+/g, " ").trim();
        }

        let book = [`<span>I am a lawyer at an engineering company</span>, so I had to pay close attention to every little detail on
        all those papers. I also had to draft a very important contract that could improve our company's future, which filled me
        with anxiety. This document could leave no room for interpretation, so writing it was not an easy task. Every
        word needed to be chosen carefully. If I made a mistake, even a small one, the consequences could be terrible.

        I do not think anyone had lunch that day, just a huge number of cups of coffee. Eventually, people started
        ordering food. I looked at the clock on the wall: it was past 9 pm, so I ate a salad and some garlic bread at my
        desk, which helped me to keep going. Everyone was tired, but we pressed on regardless. aaa aaa aaa aaa aaa aaa aaa aaa aaa 
        aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa bbb aaa aaa aaa aaa aaa aaa aaa aaa 
        aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa aaa 
        aaa aaa aaa aaa aaa aaa aaa ccc`];

        // ======= ADIÇÕES MÍNIMAS: binária e medição =======
        const escapeHtml = (s) => s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        function syncMeasurerStyle(readerEl, measurerEl) {
            const cs = getComputedStyle(readerEl);
            measurerEl.style.width = cs.width;
            measurerEl.style.paddingTop = cs.paddingTop;
            measurerEl.style.paddingRight = cs.paddingRight;
            measurerEl.style.paddingBottom = cs.paddingBottom;
            measurerEl.style.paddingLeft = cs.paddingLeft;
            measurerEl.style.boxSizing = cs.boxSizing;
            measurerEl.style.fontFamily = cs.fontFamily;
            measurerEl.style.fontSize = cs.fontSize;
            measurerEl.style.lineHeight = cs.lineHeight;
            measurerEl.style.letterSpacing = cs.letterSpacing;
            measurerEl.style.textAlign = cs.textAlign;
            measurerEl.style.whiteSpace = "normal";
        }

        function fitsInPagePlainText(text, readerEl, measurerEl) {
            measurerEl.innerHTML = "<p>" + escapeHtml(text) + "</p>";
            const hM = measurerEl.getBoundingClientRect().height;
            const hR = readerEl.getBoundingClientRect().height;
            console.log(hR)
            return hM <= hR + 0.5;
        }

        function fitParagraphPrefix(paragraph) {
            const readerEl = document.querySelector(".reader");
            const measurerEl = document.getElementById("measurer");
            syncMeasurerStyle(readerEl, measurerEl);

            let low = 0;
            let high = paragraph.length;
            let best = 0;

            // Atalho: se o parágrafo inteiro cabe, retorna comprimento total
            if (fitsInPagePlainText(paragraph, readerEl, measurerEl)) return paragraph.length;

            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                const candidate = paragraph.slice(0, mid) + "…";
                if (fitsInPagePlainText(candidate, readerEl, measurerEl)) {
                    best = mid;
                    low = mid + 1;   // tenta maior
                } else {
                    high = mid - 1;  // tenta menor
                }
            }
            return best; // maior prefixo que coube
        }
        // ================================================

        window.addEventListener("DOMContentLoaded", () => {
            let txt = strip(book[0]);

            const idx = fitParagraphPrefix(txt);
            console.log("fitParagraphPrefix length =", idx, "preview =", txt.slice(0, idx));

            document.querySelector(".reader").innerHTML += txt.slice(idx);
        });
    </script>
</head>

<body>
    <header class="topbar">
        <div class="topbar title">A Sea of Darkness</div>
    </header>

    <div class="reader"></div>
    <div class="footer">
        <button class="nav-btn">❮</button>
        <span class="progress">0%</span>
        <button class="nav-btn">❯</button>
    </div>

    <!-- medidor invisível -->
    <div id="measurer" aria-hidden="true"></div>
</body>

</html>
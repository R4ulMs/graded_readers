<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Reader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400&display=swap" rel="stylesheet">
    <style>
        html {
            -webkit-text-size-adjust: 100%;
        }

        :root {
            --topbar-h: clamp(32px, 5vh, 44px);
            --footer-h: clamp(44px, 7vh, 64px);
            --tip-safe: clamp(64px, 10vh, 128px);
            --col-ch: 62;
        }

        @media (max-width: 480px) {
            :root {
                --col-ch: 44;
            }
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: #1c1c1c;
            font-family: "Open Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            font-weight: 400;
            font-size: clamp(19px, 2.6vh, 24px);
            line-height: 1.58;
            letter-spacing: .32px;
            text-align: left;
            display: flex;
            justify-content: center;
            overflow-x: hidden;
        }

        .reader {
            width: 100%;
            max-width: min(994px, calc(var(--col-ch)*1ch));
            padding: clamp(20px, 3.5vh, 40px) clamp(16px, 4vw, 48px);
            color: #cfcfcf;
            background: #000;
            box-sizing: border-box;
            height: calc(100vh - var(--topbar-h) - var(--footer-h));
            margin-top: var(--topbar-h);
            margin-bottom: var(--footer-h);
            overflow: hidden;
        }

        .reader .phrase:hover {
            background: #2a2a2a;
            color: #fff;
            cursor: pointer;
        }

        .topbar {
            position: fixed;
            inset: 0 0 auto 0;
            height: var(--topbar-h);
            background: #000;
            display: grid;
            place-items: center;
            border-bottom: 1px solid #1f1f1f;
            z-index: 10;
            padding-top: env(safe-area-inset-top);
        }

        .topbar.title {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .footer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--footer-h);
            background: #000;
            display: flex;
            align-items: center;
            justify-content: space-around;
            color: #ccc;
            font-size: clamp(14px, 1.8vh, 16px);
            border-top: 1px solid #333;
            z-index: 10;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }

        .footer .progress {
            font-size: clamp(12px, 1.6vh, 14px);
        }

        .footer .nav-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: clamp(22px, 3.8vh, 26px);
            cursor: pointer;
            padding: 8px;
        }

        .footer .nav-btn:hover {
            color: #fff;
        }

        #measurer {
            position: absolute;
            visibility: hidden;
            left: -9999px;
            top: -9999px;
            padding: 40px 125px;
            box-sizing: border-box;
            font-size: inherit;
            line-height: inherit;
            letter-spacing: .32px;
            white-space: normal;
            text-align: left;
        }

        .tip-wrap {
            position: relative;
            display: inline-block;
        }

        .tip-trigger {
            cursor: pointer;
        }

        .tooltip {
            position: absolute;
            left: 0;
            top: 100%;
            transform: translateY(8px);
            width: 280px;
            max-width: min(80vw, 400px);
            padding: 8px 10px;
            border: 2px solid #ccc;
            background: #141414;
            color: #fff;
            font-size: 14px;
            line-height: 1.3;
            white-space: normal;
            overflow-wrap: anywhere;
            opacity: 0;
            pointer-events: none;
            transition: opacity .12s ease;
            z-index: 12;
        }

        .tooltip::before,
        .tooltip::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 14px;
            width: 0;
            height: 0;
            border: solid transparent;
            pointer-events: none;
        }

        .tooltip::before {
            border-width: 8px;
            border-bottom-color: #ccc;
            margin-left: -2px;
        }

        .tooltip::after {
            border-width: 6px;
            border-bottom-color: #141414;
        }

        .tip-wrap[data-open="true"] .tooltip {
            opacity: 1;
            pointer-events: auto;
        }

        .reader p {
            margin: 0 0 .65em;
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="topbar title">A Sea of Darkness</div>
    </header>
    <div class="reader"></div>
    <div class="footer">
        <button class="nav-btn">❮</button>
        <span class="progress">0%</span>
        <button class="nav-btn">❯</button>
    </div>
    <div id="measurer" aria-hidden="true"></div>

    <script>
        const TIP_SAFE = Math.max(64, Math.min(window.innerHeight * 0.10, 128));
        const STORAGE_KEY = "reader:page:v1";
        const TIP_FOLGA = 80; // px de folga para o tooltip aparecer acima do rodapé

        const story = {
            "page1": [
                { "phrase": "Late in the winter", "tooltip": "No fim do inverno" },
                { "phrase": "of my seventeenth year,", "tooltip": "do meu décimo sétimo ano" },
                { "phrase": "my mother decided", "tooltip": "minha mãe decidiu" },
                { "phrase": "I was depressed,", "tooltip": "que eu estava deprimida" },

                { "phrase": "presumably because", "tooltip": "provavelmente porque" },
                { "phrase": "I rarely left the house,", "tooltip": "raramente saía de casa" },
                { "phrase": "spent quite a lot of time in bed,", "tooltip": "passava muito tempo na cama" },
                { "phrase": "read the same book over and over,", "tooltip": "lia o mesmo livro repetidas vezes" },
                { "phrase": "ate infrequently,", "tooltip": "comia com pouca frequência" },
                { "phrase": "and devoted quite a bit of my abundant free time", "tooltip": "e dedicava bastante do meu abundante tempo livre" },
                { "phrase": "to thinking about death.", "tooltip": "a pensar sobre a morte" },

                { "phrase": "Whenever you read", "tooltip": "Sempre que você lê" },
                { "phrase": "a cancer booklet or website or whatever,", "tooltip": "um livreto de câncer ou site ou seja o que for" },
                { "phrase": "they always list depression", "tooltip": "eles sempre listam depressão" },
                { "phrase": "among the side effects of cancer.", "tooltip": "entre os efeitos colaterais do câncer" },
                { "phrase": "But, in fact,", "tooltip": "Mas, na verdade" },
                { "phrase": "depression is not a side effect of cancer.", "tooltip": "depressão não é efeito colateral do câncer" },
                { "phrase": "Depression is a side effect of dying.", "tooltip": "depressão é efeito colateral de morrer" },
                { "phrase": "(Cancer is also a side effect of dying.", "tooltip": "(Câncer também é efeito colateral de morrer" },
                { "phrase": "Almost everything is, really.)", "tooltip": "Quase tudo é, na verdade.)" },

                { "phrase": "But my mom believed I required treatment,", "tooltip": "Mas minha mãe acreditava que eu precisava de tratamento" },
                { "phrase": "so she took me to see my Regular Doctor Jim,", "tooltip": "então ela me levou para ver meu Médico Regular Jim" },
                { "phrase": "who agreed that I was veritably swimming", "tooltip": "que concordou que eu estava verdadeiramente nadando" },
                { "phrase": "in a paralyzing and totally clinical depression,", "tooltip": "em uma depressão paralisante e totalmente clínica" },
                { "phrase": "and that therefore", "tooltip": "e que portanto" },
                { "phrase": "my meds should be adjusted", "tooltip": "meus remédios deveriam ser ajustados" },
                { "phrase": "and also I should attend", "tooltip": "e também eu deveria frequentar" },
                { "phrase": "a weekly Support Group.", "tooltip": "um Grupo de Apoio semanal" },

                { "phrase": "This Support Group featured", "tooltip": "Esse Grupo de Apoio apresentava" },
                { "phrase": "a rotating cast of characters", "tooltip": "um elenco rotativo de personagens" },
                { "phrase": "in various states of tumor-driven unwellness.", "tooltip": "em vários estados de mal-estar causado por tumor" },
                { "phrase": "Why did the cast rotate?", "tooltip": "Por que o elenco rotacionava?" },
                { "phrase": "A side effect of dying.", "tooltip": "Um efeito colateral de morrer" },

                { "phrase": "The Support Group, of course,", "tooltip": "O Grupo de Apoio, claro" },
                { "phrase": "was depressing as hell.", "tooltip": "era deprimente pra caramba" },
                { "phrase": "It met every Wednesday", "tooltip": "se reunia toda quarta-feira" },
                { "phrase": "in the basement of a stone-walled Episcopal church", "tooltip": "no porão de uma igreja Episcopal de paredes de pedra" },
                { "phrase": "shaped like a cross.", "tooltip": "em formato de cruz" },
                { "phrase": "We all sat in a circle", "tooltip": "todos sentávamos em um círculo" },
                { "phrase": "right in the middle of the cross,", "tooltip": "bem no meio da cruz" },
                { "phrase": "where the two boards would have met,", "tooltip": "onde as duas tábuas se encontrariam" },
                { "phrase": "where the heart of Jesus would have been.", "tooltip": "onde o coração de Jesus teria estado" },

                { "phrase": "I noticed this because Patrick,", "tooltip": "Notei isso porque Patrick" },
                { "phrase": "the Support Group Leader", "tooltip": "o Líder do Grupo de Apoio" },
                { "phrase": "and only person over eighteen in the room,", "tooltip": "e única pessoa acima de dezoito anos na sala" },
                { "phrase": "talked about the heart of Jesus", "tooltip": "falava sobre o coração de Jesus" },
                { "phrase": "every freaking meeting,", "tooltip": "em toda maldita reunião" },
                { "phrase": "all about how we,", "tooltip": "tudo sobre como nós" },
                { "phrase": "as young cancer survivors,", "tooltip": "como jovens sobreviventes do câncer" },
                { "phrase": "were sitting right in Christ’s very sacred heart", "tooltip": "estávamos sentados bem no sagrado coração de Cristo" },
                { "phrase": "and whatever.", "tooltip": "e sei lá" },

                { "phrase": "So here’s how it went in God’s heart:", "tooltip": "Então aqui está como acontecia no coração de Deus:" },
                { "phrase": "The six or seven or ten of us", "tooltip": "Nós seis ou sete ou dez" },
                { "phrase": "walked/wheeled in,", "tooltip": "entrávamos andando/rodando" },
                { "phrase": "grazed at a decrepit selection of cookies and lemonade,", "tooltip": "beliscávamos uma seleção decadente de biscoitos e limonada" },
                { "phrase": "sat down in the Circle of Trust,", "tooltip": "sentávamos no Círculo da Confiança" },
                { "phrase": "and listened to Patrick recount", "tooltip": "e ouvíamos Patrick contar" },
                { "phrase": "for the thousandth time", "tooltip": "pela milésima vez" },
                { "phrase": "his depressingly miserable life story—", "tooltip": "sua história de vida miseravelmente deprimente—" },
                { "phrase": "how he had cancer in his balls", "tooltip": "como ele teve câncer nos testículos" },
                { "phrase": "and they thought he was going to die", "tooltip": "e acharam que ele ia morrer" },
                { "phrase": "but he didn’t die", "tooltip": "mas ele não morreu" },
                { "phrase": "and now here he is,", "tooltip": "e agora aqui está ele" },
                { "phrase": "a full-grown adult", "tooltip": "um adulto completamente crescido" },
                { "phrase": "in a church basement", "tooltip": "em um porão de igreja" },
                { "phrase": "in the 137th nicest city in America,", "tooltip": "na 137ª cidade mais legal da América" },
                { "phrase": "divorced,", "tooltip": "divorciado" },
                { "phrase": "addicted to video games,", "tooltip": "viciado em videogames" },
                { "phrase": "mostly friendless,", "tooltip": "quase sem amigos" },
                { "phrase": "eking out a meager living", "tooltip": "sobrevivendo com uma vida miserável" },
                { "phrase": "by exploiting his cancertastic past,", "tooltip": "explorando seu passado cancer-tástico" },
                { "phrase": "slowly working his way", "tooltip": "lentamente trabalhando seu caminho" },
                { "phrase": "toward a master’s degree", "tooltip": "em direção a um mestrado" },
                { "phrase": "that will not improve his career prospects,", "tooltip": "que não vai melhorar suas perspectivas de carreira" },
                { "phrase": "waiting, as we all do,", "tooltip": "esperando, como todos nós fazemos" },
                { "phrase": "for the sword of Damocles", "tooltip": "pela espada de Dâmocles" },
                { "phrase": "to give him the relief", "tooltip": "para lhe dar o alívio" },
                { "phrase": "that he escaped lo those many years ago", "tooltip": "do qual escapou há muitos anos atrás" },
                { "phrase": "when cancer took both of his nuts", "tooltip": "quando o câncer levou as duas bolas dele" },
                { "phrase": "but spared what only the most generous soul", "tooltip": "mas poupou o que só a alma mais generosa" },
                { "phrase": "would call his life.", "tooltip": "chamaria de vida dele" },

                { "phrase": "AND YOU TOO MIGHT BE SO LUCKY!", "tooltip": "E VOCÊ TAMBÉM PODERIA TER TANTA SORTE!" },

                { "phrase": "Then we introduced ourselves:", "tooltip": "Então nos apresentamos:" },
                { "phrase": "Name. Age. Diagnosis.", "tooltip": "Nome. Idade. Diagnóstico." },
                { "phrase": "And how we’re doing today.", "tooltip": "E como estamos hoje" },
                { "phrase": "I’m Hazel,", "tooltip": "Eu sou Hazel" },
                { "phrase": "I’d say when they’d get to me.", "tooltip": "eu dizia quando chegava a minha vez" },
                { "phrase": "Sixteen.", "tooltip": "Dezesseis" },
                { "phrase": "Thyroid originally", "tooltip": "Tireoide originalmente" },
                { "phrase": "but with an impressive", "tooltip": "mas com uma impressionante" },
                { "phrase": "and long-settled satellite colony in my lungs.", "tooltip": "e há muito instalada colônia satélite nos meus pulmões" },
                { "phrase": "And I’m doing okay.", "tooltip": "E eu estou indo bem" },

                { "phrase": "Once we got around the circle,", "tooltip": "Quando terminamos a volta no círculo" },
                { "phrase": "Patrick always asked", "tooltip": "Patrick sempre perguntava" },
                { "phrase": "if anyone wanted to share.", "tooltip": "se alguém queria compartilhar" },
                { "phrase": "And", "tooltip": "E" }
            ]
        };

        const escapeHtml = s => s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        const syncMeasurerStyle = (readerEl, measurerEl) => {
            const cs = getComputedStyle(readerEl);
            measurerEl.style.width = cs.width;
            measurerEl.style.paddingTop = cs.paddingTop;
            measurerEl.style.paddingRight = cs.paddingRight;
            measurerEl.style.paddingBottom = cs.paddingBottom;
            measurerEl.style.paddingLeft = cs.paddingLeft;
            measurerEl.style.boxSizing = cs.boxSizing;
            measurerEl.style.fontFamily = cs.fontFamily;
            measurerEl.style.fontSize = cs.fontSize;
            measurerEl.style.lineHeight = cs.lineHeight;
            measurerEl.style.letterSpacing = cs.letterSpacing;
            measurerEl.style.textAlign = "left";
            measurerEl.style.whiteSpace = "normal";
        };

        function isFitPage(text, readerEl, measurerEl, safePx = TIP_SAFE) {
            measurerEl.innerHTML = "<p>" + escapeHtml(text) + "</p>";
            const hM = measurerEl.getBoundingClientRect().height;
            const readerH = readerEl.getBoundingClientRect().height;
            const available = readerH - safePx;
            return hM <= available + 0.5;
        }

        function fitPage(paragraph, safePx = TIP_SAFE + TIP_FOLGA) {
            const readerEl = document.querySelector(".reader");
            const measurerEl = document.getElementById("measurer");
            syncMeasurerStyle(readerEl, measurerEl);
            let low = 0, high = paragraph.length, best = 0;
            if (isFitPage(paragraph, readerEl, measurerEl, safePx)) return paragraph.length;
            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                const candidate = paragraph.slice(0, mid) + "…";
                if (isFitPage(candidate, readerEl, measurerEl, safePx)) { best = mid; low = mid + 1; }
                else { high = mid - 1; }
            }
            return best;
        }

        function buildFullTextWithIndex(items) {
            let fullText = "", index = [], pos = 0;
            items.forEach((it, i) => {
                if (i > 0) { fullText += " "; pos += 1; }
                const start = pos; fullText += it.phrase; const end = pos + it.phrase.length;
                index.push({ start, end, tooltip: it.tooltip }); pos = end;
            });
            return { fullText, index };
        }

        function paginateRanges(fullText) {
            const pages = []; let rest = fullText; let offset = 0;
            while (rest.length > 0) {
                const take = fitPage(rest);
                const len = take > 0 ? take : Math.min(100, rest.length);
                pages.push({ start: offset, end: offset + len });
                rest = rest.slice(len); offset += len;
            }
            return pages;
        }

        // ---- posiciona tooltip dentro da viewport
        function placeTooltip(wrap) {
            const tip = wrap.querySelector('.tooltip');
            if (!tip) return;
            // reset base
            tip.style.left = '0';
            tip.style.right = 'auto';
            tip.style.transform = 'translateY(8px)';

            requestAnimationFrame(() => {
                const vw = window.innerWidth;
                const pad = 8; // margem mínima
                const rWrap = wrap.getBoundingClientRect();
                const rTip = tip.getBoundingClientRect();

                // posição desejada relativa ao wrap (lado esquerdo)
                let desiredLeftViewport = rWrap.left;              // encostar no wrap
                // clamp dentro da viewport
                if (desiredLeftViewport + rTip.width > vw - pad) {
                    desiredLeftViewport = vw - pad - rTip.width;
                }
                if (desiredLeftViewport < pad) {
                    desiredLeftViewport = pad;
                }
                // converte para coordenada relativa ao wrap
                const leftWithinWrap = desiredLeftViewport - rWrap.left;
                tip.style.left = leftWithinWrap + 'px';
            });
        }

        function buildPageHtml(fullText, phraseIndex, range) {
            if (!range) return "";
            const overlaps = phraseIndex
                .filter(({ start, end }) => end > range.start && start < range.end)
                .sort((a, b) => a.start - b.start);

            let html = "", cursor = range.start;
            const pushRaw = (from, to) => { if (to > from) html += escapeHtml(fullText.slice(from, to)); };

            overlaps.forEach(({ start, end, tooltip }) => {
                const s = Math.max(start, range.start);
                const e = Math.min(end, range.end);
                pushRaw(cursor, s);
                const frag = escapeHtml(fullText.slice(s, e));
                const tip = escapeHtml(tooltip || "");
                html += `
          <span class="tip-wrap">
            <span class="tip-trigger phrase">${frag}</span>
            <span class="tooltip" role="tooltip">${tip}</span>
          </span>`;
                cursor = e;
            });
            pushRaw(cursor, range.end);
            return html;
        }

        function installTooltipController() {
            const closeAll = () => {
                document.querySelectorAll('.tip-wrap[data-open="true"]').forEach(w => {
                    w.setAttribute('data-open', 'false');
                    const t = w.querySelector('.tip-trigger'); if (t) t.setAttribute('aria-expanded', 'false');
                });
            };

            document.addEventListener('click', (ev) => {
                const trigger = ev.target.closest('.tip-trigger');
                const wrap = ev.target.closest('.tip-wrap');
                if (trigger && wrap) {
                    ev.stopPropagation();
                    const isOpen = wrap.getAttribute('data-open') === 'true';
                    closeAll();
                    wrap.setAttribute('data-open', String(!isOpen));
                    trigger.setAttribute('aria-expanded', String(!isOpen));
                    if (!isOpen) { placeTooltip(wrap); } // posiciona ao abrir
                    return;
                }
                if (!wrap) closeAll();
            });

            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAll(); });

            // Reposiciona tooltips abertos no resize/rotação
            window.addEventListener('resize', () => {
                document.querySelectorAll('.tip-wrap[data-open="true"]').forEach(placeTooltip);
            });
        }

        const clampPage = (p, len) => len <= 0 ? 0 : Math.max(0, Math.min(p, len - 1));

        window.addEventListener("DOMContentLoaded", () => {
            const items = story.page1;
            const { fullText, index: phraseIndex } = buildFullTextWithIndex(items);
            let pages = paginateRanges(fullText);

            const saved = parseInt(localStorage.getItem(STORAGE_KEY) || "0", 10);
            let page = clampPage(Number.isFinite(saved) ? saved : 0, pages.length);

            const reader = document.querySelector(".reader");
            const progress = document.querySelector(".progress");
            const [prevBtn, nextBtn] = document.querySelectorAll(".nav-btn");

            const render = () => {
                if (!pages || pages.length === 0) {
                    reader.innerHTML = ""; progress.textContent = "0%";
                    prevBtn.disabled = nextBtn.disabled = true; return;
                }
                page = clampPage(page, pages.length);
                const range = pages[page];
                reader.innerHTML = buildPageHtml(fullText, phraseIndex, range);
                progress.textContent = `${Math.round(((page + 1) / pages.length) * 100)}%`;
                prevBtn.disabled = page === 0;
                nextBtn.disabled = page === pages.length - 1;
                localStorage.setItem(STORAGE_KEY, String(page));
                document.querySelectorAll('.tip-wrap[data-open="true"]').forEach(w => w.setAttribute('data-open', 'false'));
            };

            prevBtn.addEventListener("click", () => { if (page > 0) { page--; render(); } });
            nextBtn.addEventListener("click", () => { if (page < pages.length - 1) { page++; render(); } });

            // Re-paginar ao redimensionar/rotacionar
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    pages = paginateRanges(fullText);
                    page = clampPage(page, pages.length);
                    render();
                }, 120);
            });

            installTooltipController();
            render();
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400&display=swap" rel="stylesheet">
    <meta charset="UTF-8" />
    <title>Reader</title>
    <style>
        :root {
            --topbar-h: 28px;
            --footer-h: 25px;
            --tip-safe: clamp(64px, 10vh, 128px);
        }

        body {
            background-color: #1c1c1c;
            font-family: "Open Sans", sans-serif;
            font-weight: 400;
            font-size: 24px;
            line-height: 1.583;
            letter-spacing: .32px;
            text-align: left;
            display: flex;
            justify-content: center;
        }

        .reader {
            max-width: 994px;
            min-width: 994px;
            padding: 40px;
            color: #cfcfcf;
            background: #000;
            padding-left: 125px;
            padding-right: 125px;
            box-sizing: border-box;
            height: calc(100vh - var(--topbar-h) - var(--footer-h));
            margin-top: var(--topbar-h);
            margin-bottom: var(--footer-h);
            overflow: hidden;
        }

        .reader .phrase:hover {
            background: #2a2a2a;
            color: #fff;
            cursor: pointer;
        }

        .topbar {
            position: fixed;
            inset: 0 0 auto 0;
            height: 35px;
            background: #000;
            display: grid;
            place-items: center;
            border-bottom: 1px solid #1f1f1f;
            z-index: 10;
        }

        .topbar.title {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: space-around;
            color: #ccc;
            font-size: 16px;
            border-top: 1px solid #333;
            z-index: 10;
        }

        .footer .progress {
            font-size: 14px;
        }

        .footer .nav-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 26px;
            cursor: pointer;
            padding: 8px;
        }

        .footer .nav-btn:hover {
            color: #fff;
        }

        /* medidor invisível */
        #measurer {
            position: absolute;
            visibility: hidden;
            left: -9999px;
            top: -9999px;
            width: 994px;
            padding: 40px 125px;
            box-sizing: border-box;
            font-size: 24px;
            line-height: 1.583;
            letter-spacing: .32px;
            white-space: normal;
        }

        /* ===== Tooltip estilo de referência (com setinha) ===== */
        .tip-wrap {
            position: relative;
            display: inline-block;
        }

        .tip-trigger {
            cursor: pointer;
        }

        .tooltip {
            position: absolute;
            left: 0;
            top: 100%;
            transform: translateY(8px);
            width: 280px;
            max-width: 400px;
            padding: 8px 10px;
            border: 2px solid #ccc;
            background: #141414;
            color: #fff;
            font-size: 14px;
            line-height: 1.3;
            white-space: normal;
            overflow-wrap: break-word;
            opacity: 0;
            pointer-events: none;
            transition: opacity .12s ease;
            z-index: 12;
        }

        .tooltip::before,
        .tooltip::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 14px;
            width: 0;
            height: 0;
            border: solid transparent;
            pointer-events: none;
        }

        .tooltip::before {
            border-width: 8px;
            border-bottom-color: #ccc;
            margin-left: -2px;
        }

        .tooltip::after {
            border-width: 6px;
            border-bottom-color: #141414;
        }

        .tip-wrap[data-open="true"] .tooltip {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="topbar title">A Sea of Darkness</div>
    </header>

    <div class="reader"></div>

    <div class="footer">
        <button class="nav-btn">❮</button>
        <span class="progress">0%</span>
        <button class="nav-btn">❯</button>
    </div>

    <!-- medidor invisível -->
    <div id="measurer" aria-hidden="true"></div>

    <script>
        const TIP_SAFE = Math.max(64, Math.min(window.innerHeight * 0.10, 128));

        // ===== conteúdo em JSON (frases + tooltip) =====
        const story = {
            "page1": [
                { "phrase": "Maria acordou cedo", "tooltip": "Início do dia" },
                { "phrase": "O sol já brilhava na janela", "tooltip": "Manhã ensolarada" },
                { "phrase": "Ela se espreguiçou devagar", "tooltip": "Acordando o corpo" },
                { "phrase": "Foi até a cozinha", "tooltip": "Primeiro destino" },
                { "phrase": "Preparou um copo de água", "tooltip": "Hábito saudável" },
                { "phrase": "Olhou o relógio", "tooltip": "Verificar horário" },
                { "phrase": "Percebeu que estava com fome", "tooltip": "Sensação matinal" },
                { "phrase": "Decidiu ir à padaria", "tooltip": "Tomada de decisão" },
                { "phrase": "Colocou um casaco leve", "tooltip": "Preparando-se para sair" },
                { "phrase": "Saiu de casa", "tooltip": "Início do trajeto" },
                { "phrase": "As ruas estavam tranquilas", "tooltip": "Ambiente calmo" },
                { "phrase": "Cumprimentou a vizinha", "tooltip": "Interação rápida" },
                { "phrase": "Chegando à padaria", "tooltip": "No local" },
                { "phrase": "Viu uma pequena fila", "tooltip": "Movimento do lugar" },
                { "phrase": "Queria comprar pão", "tooltip": "Objetivo principal" },
                { "phrase": "Notou que os pães haviam acabado", "tooltip": "Decepção" },
                { "phrase": "Maria suspirou fundo", "tooltip": "Reação emocional" },
                { "phrase": "Pensou em outras opções", "tooltip": "Reflexão rápida" },
                { "phrase": "Decidiu comprar café", "tooltip": "Nova escolha" },
                { "phrase": "Pegou também um pedaço de bolo", "tooltip": "Pequena indulgência" },
                { "phrase": "Pagou no caixa", "tooltip": "Finalizando a compra" },
                { "phrase": "Agradeceu ao atendente", "tooltip": "Gentileza" },
                { "phrase": "Saiu da padaria", "tooltip": "Fim da compra" },
                { "phrase": "Sentiu o cheiro do café fresco", "tooltip": "Sensação agradável" },
                { "phrase": "Começou a voltar pra casa", "tooltip": "Retorno" },
                { "phrase": "Reparou nas flores da calçada", "tooltip": "Detalhes do caminho" },
                { "phrase": "Ouviu pássaros cantando", "tooltip": "Som ambiente" },
                { "phrase": "Entrou em casa novamente", "tooltip": "Chegada" },
                { "phrase": "Preparou a mesa para o café da manhã", "tooltip": "Organização" },
                { "phrase": "Ficou contente com o início do dia", "tooltip": "Fim feliz" },
                { "phrase": "Pegou uma xícara bonita do armário", "tooltip": "Escolha cuidadosa" },
                { "phrase": "Serviu o café fumegante", "tooltip": "Primeiro gole chegando" },
                { "phrase": "O aroma se espalhou pela cozinha", "tooltip": "Atmosfera aconchegante" },
                { "phrase": "Cortou um pedaço do bolo", "tooltip": "Preparando o prato" },
                { "phrase": "Deu a primeira mordida", "tooltip": "Início do café da manhã" },
                { "phrase": "Sorriu ao sentir o sabor doce", "tooltip": "Pequena felicidade" },
                { "phrase": "Olhou pela janela", "tooltip": "Momento de contemplação" },
                { "phrase": "Viu crianças brincando na rua", "tooltip": "Cena cotidiana" },
                { "phrase": "Lembrou da sua infância", "tooltip": "Recordação" },
                { "phrase": "Sentiu uma onda de nostalgia", "tooltip": "Emoção suave" },
                { "phrase": "Terminou seu café lentamente", "tooltip": "Aproveitando o momento" },
                { "phrase": "Decidiu anotar suas tarefas do dia", "tooltip": "Organização pessoal" },
                { "phrase": "Pegou papel e caneta", "tooltip": "Preparando-se" },
                { "phrase": "Escreveu uma pequena lista", "tooltip": "Planejamento" },
                { "phrase": "Percebeu que o dia seria produtivo", "tooltip": "Perspectiva positiva" }
            ]
        };

        const escapeHtml = (s) => s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        const syncMeasurerStyle = (readerEl, measurerEl) => {
            const cs = getComputedStyle(readerEl);
            measurerEl.style.width = cs.width;
            measurerEl.style.paddingTop = cs.paddingTop;
            measurerEl.style.paddingRight = cs.paddingRight;
            measurerEl.style.paddingBottom = cs.paddingBottom;
            measurerEl.style.paddingLeft = cs.paddingLeft;
            measurerEl.style.boxSizing = cs.boxSizing;
            measurerEl.style.fontFamily = cs.fontFamily;
            measurerEl.style.fontSize = cs.fontSize;
            measurerEl.style.lineHeight = cs.lineHeight;
            measurerEl.style.letterSpacing = cs.letterSpacing;
            measurerEl.style.textAlign = cs.textAlign;
            measurerEl.style.whiteSpace = "normal";
        };

        function isFitPage(text, readerEl, measurerEl, safePx = TIP_SAFE) {
            measurerEl.innerHTML = "<p>" + escapeHtml(text) + "</p>";
            const hM = measurerEl.getBoundingClientRect().height;
            const readerH = readerEl.getBoundingClientRect().height;
            const available = readerH - safePx;           // <- aqui está o “height - N”
            return hM <= available + 0.5;
        }

        function fitPage(paragraph, safePx = TIP_SAFE) {
            const readerEl = document.querySelector(".reader");
            const measurerEl = document.getElementById("measurer");
            syncMeasurerStyle(readerEl, measurerEl);

            let low = 0, high = paragraph.length, best = 0;

            if (isFitPage(paragraph, readerEl, measurerEl, safePx)) return paragraph.length;

            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                const candidate = paragraph.slice(0, mid) + "…";
                if (isFitPage(candidate, readerEl, measurerEl, safePx)) {
                    best = mid; low = mid + 1;
                } else {
                    high = mid - 1;
                }
            }
            return best;
        }

        function buildFullTextWithIndex(items) {
            let fullText = "", index = [], pos = 0;
            items.forEach((it, i) => {
                if (i > 0) { fullText += " "; pos += 1; }
                const start = pos;
                fullText += it.phrase;
                const end = pos + it.phrase.length;
                index.push({ start, end, tooltip: it.tooltip });
                pos = end;
            });
            return { fullText, index };
        }

        function paginateRanges(fullText) {
            const pages = []; let rest = fullText; let offset = 0;
            while (rest.length > 0) {
                const take = fitPage(rest);
                const len = take > 0 ? take : Math.min(100, rest.length);
                pages.push({ start: offset, end: offset + len });
                rest = rest.slice(len); offset += len;
            }
            return pages;
        }

        // Constrói o HTML da página com o tooltip de referência
        function buildPageHtml(fullText, phraseIndex, range) {
            const overlaps = phraseIndex
                .filter(({ start, end }) => end > range.start && start < range.end)
                .sort((a, b) => a.start - b.start);

            let html = "", cursor = range.start;
            const pushRaw = (from, to) => {
                if (to > from)
                    html += escapeHtml(fullText.slice(from, to));
            };

            overlaps.forEach(({ start, end, tooltip }) => {
                const s = Math.max(start, range.start);
                const e = Math.min(end, range.end);

                pushRaw(cursor, s);

                const frag = escapeHtml(fullText.slice(s, e));
                const tip = escapeHtml(tooltip || "");

                html += `
                <span class="tip-wrap">
                    <span class="tip-trigger phrase">${frag}</span>
                    <span class="tooltip" role="tooltip">${tip}</span>
                </span>`;

                cursor = e;
            });

            pushRaw(cursor, range.end);

            return html;
        }

        // Controle global dos tooltips (igual ao exemplo de referência)
        function installTooltipController() {
            const closeAll = () => {
                document.querySelectorAll('.tip-wrap[data-open="true"]').forEach(w => {
                    w.setAttribute('data-open', 'false');
                    const t = w.querySelector('.tip-trigger');
                    if (t) t.setAttribute('aria-expanded', 'false');
                });
            };

            document.addEventListener('click', (ev) => {
                const trigger = ev.target.closest('.tip-trigger');
                const anyWrap = ev.target.closest('.tip-wrap');

                if (trigger && anyWrap) {
                    ev.stopPropagation();
                    const isOpen = anyWrap.getAttribute('data-open') === 'true';

                    closeAll();

                    anyWrap.setAttribute('data-open', String(!isOpen));
                    trigger.setAttribute('aria-expanded', String(!isOpen));

                    return;
                }
                if (!anyWrap) closeAll();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.tip-wrap[data-open="true"]').forEach(w => w.setAttribute('data-open', 'false'));
                }
            });
        }

        window.addEventListener("DOMContentLoaded", () => {
            const items = story.page1;
            const { fullText, index: phraseIndex } = buildFullTextWithIndex(items);
            const pages = paginateRanges(fullText);

            let page = 0;
            const reader = document.querySelector(".reader");
            const progress = document.querySelector(".progress");
            const [prevBtn, nextBtn] = document.querySelectorAll(".nav-btn");

            const render = () => {
                const range = pages[page];
                reader.innerHTML = buildPageHtml(fullText, phraseIndex, range);
                progress.textContent = `${Math.round(((page + 1) / pages.length) * 100)}%`;
                prevBtn.disabled = page === 0;
                nextBtn.disabled = page === pages.length - 1;

                // fecha tooltips abertos ao trocar de página
                document.querySelectorAll('.tip-wrap[data-open="true"]').forEach(w => w.setAttribute('data-open', 'false'));
            };

            prevBtn.addEventListener("click", () => { if (page > 0) { page--; render(); } });
            nextBtn.addEventListener("click", () => { if (page < pages.length - 1) { page++; render(); } });

            installTooltipController();
            render();
        });
    </script>
</body>

</html>